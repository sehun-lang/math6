<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>소수의 나눗셈 레벨업 RPG</title>
  <style>
    :root{
      --bg:#0f1226; --panel:#171b39; --ink:#e8ecff; --sub:#9aa3d0;
      --accent:#6ae3ff; --good:#3ce27a; --bad:#ff6b6b; --rare:#b794f4; --legend:#ffd166; --myth:#ff7de9; --unique:#6aff6a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,Arial,sans-serif;color:var(--ink);background:radial-gradient(1200px 600px at 70% -10%,#223 0%, #101325 55%, #0b0e1c 100%), var(--bg);}    
    .wrap{height:100vh;max-width:1180px;margin:0 auto;padding:16px;display:grid;grid-template-rows:auto 1fr}
    header{display:flex;align-items:center;gap:12px}
    h1{font-size:18px;margin:0;font-weight:800;letter-spacing:0.2px}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);font-size:12px;color:var(--sub)}
    .layout{display:grid;grid-template-columns: 380px 1fr; gap:12px; min-height:0}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;min-height:0}
    .title{font-size:13px;color:var(--sub);margin-bottom:8px;letter-spacing:.2px}
    .row{display:flex;gap:10px;align-items:center}
    .bar{height:12px;background:#0d1125;border:1px solid rgba(255,255,255,.08);border-radius:999px;overflow:hidden}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#7bffea)}
    .hp>span{background:linear-gradient(90deg,#ff7a7a,#ffb3a7)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .big{font-size:24px;font-weight:800}
    .muted{color:var(--sub)}
    button{border:none;background:linear-gradient(180deg,#2b2f58,#1d2144);border:1px solid rgba(255,255,255,.12);color:var(--ink);padding:8px 10px;border-radius:10px;font-weight:700;cursor:pointer}
    button:hover{filter:brightness(1.08)}
    button:active{transform:translateY(1px)}
    .btn-ghost{background:transparent;border:1px dashed rgba(255,255,255,.18)}
    .btn-good{background:linear-gradient(180deg,#2a6d46,#1a4d33)}
    .btn-bad{background:linear-gradient(180deg,#6d2a2a,#4d1a1a)}
    input[type=text]{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:#0e1230;color:var(--ink);font-size:16px}
    kbd{background:#0d1230;border:1px solid rgba(255,255,255,.18);padding:2px 6px;border-radius:6px;color:var(--sub)}
    .monster{display:flex;align-items:center;gap:12px}
    .monster .emoji{font-size:28px}
    .weapon{display:flex;align-items:center;gap:8px;padding:6px;border-radius:10px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08)}
    .weapon .tag{font-size:11px;color:#111;border-radius:999px;padding:2px 8px}
    .r-rare{background:var(--rare);} .r-legend{background:var(--legend);} .r-myth{background:var(--myth);} .r-unique{background:var(--unique)}
    .inv{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;overflow:auto;max-height:180px}
    .note{font-size:12px;color:var(--sub)}
    .problem{font-size:20px;font-weight:800;letter-spacing:.2px}
    .hint{font-size:13px;color:var(--accent);}
    .log{height:140px;overflow:auto;background:#0d1026;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px;font-size:12px}
    .range{font-size:12px;color:var(--sub)}
    .small{font-size:12px}
    .lives{display:flex;gap:6px}
    .equipSlot{display:grid;grid-template-columns:1fr 1fr;gap:6px}
    .boss{filter:drop-shadow(0 0 10px #ffcf66aa)}
    .rightCol{display:grid;grid-template-rows:auto auto 1fr; gap:10px; min-height:0}
    .footer{font-size:11px;color:var(--sub);opacity:.8}
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:50}
    .overlay .panel{background:#0f1230;border:1px solid rgba(255,255,255,.2);padding:18px;border-radius:12px;max-width:720px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>소수의 나눗셈: 쓰러뜨리고 레벨업!</h1>
      <span class="pill">오프라인 · 단일 HTML · 자동 저장</span>
      <button class="btn-ghost" id="btnRange">문제 범위</button>
      <button class="btn-ghost" id="btnTests">개발자 테스트</button>
      <button class="btn-ghost" id="btnReset">초기화</button>
    </header>

    <!-- 🔗 공유/랭킹 패널 -->
    <section class="card" style="margin:10px 0; display:grid; grid-template-columns:1fr auto auto auto; gap:8px; align-items:end">
      <div>
        <div class="title">내 이름</div>
        <input id="nameInput" type="text" placeholder="예: 김민준" />
      </div>
      <div>
        <div class="title">랭킹 기준</div>
        <select id="rankBy" style="width:100%; padding:10px; border-radius:10px; background:#0e1230; color:var(--ink); border:1px solid rgba(255,255,255,.16)">
          <option value="correct">정답수</option>
          <option value="level">레벨</option>
          <option value="xp">경험치</option>
          <option value="stage">진행스테이지</option>
        </select>
      </div>
      <div style="display:flex; gap:8px">
        <button id="btnSendScore" class="btn-good">점수 전송</button>
        <button id="btnFetchRank" class="btn-ghost">랭킹 불러오기</button>
      </div>
      <div class="note" id="shareNote">온라인 모드 설정 필요: 코드 상단 URL 상수 설정</div>
    </section>


    <div class="layout">
      <section class="card" style="display:grid;grid-template-rows:auto auto auto 1fr;gap:8px;min-height:0">
        <div>
          <div class="title">플레이어</div>
          <div class="grid2">
            <div><div class="muted small">레벨</div><div class="big" id="level">1</div></div>
            <div><div class="muted small">경험치</div><div class="bar"><span id="xpbar" style="width:0%"></span></div></div>
          </div>
          <div class="row" style="margin-top:8px">
            <div style="flex:1"><div class="muted small">HP</div><div class="bar hp"><span id="hpbar" style="width:100%"></span></div></div>
            <div style="width:120px;text-align:right"><div class="muted small">공격력</div><div class="big" id="atk">5</div></div>
          </div>
          <div class="row" style="justify-content:space-between;margin-top:6px">
            <div class="muted small">스테이지 <strong id="stage">1-1</strong></div>
            <div class="lives" id="lives"></div>
          </div>
        </div>

        <div>
          <div class="title">장비</div>
          <div class="equipSlot">
            <div id="equipA" class="weapon"><span>🗡️ 무기 A 없음</span><span class="tag">빈 슬롯</span><span class="muted small">+0</span></div>
            <div id="equipB" class="weapon"><span>🗡️ 보조 슬롯 B (무기/방어구)</span><span class="tag">빈 슬롯</span><span class="muted small">+0</span></div>
          </div>
        </div>

        <div style="min-height:0">
          <div class="title">인벤토리</div>
          <div class="inv" id="inventory"></div>
          <div class="row" style="justify-content:space-between; margin-top:6px">
            <div class="note">아이템을 판매해 <strong>랜덤 뽑기</strong> 가능 (실패 75%)</div>
            <button id="btnSellDraw" class="btn-ghost">판매→뽑기</button>
          </div>
        </div>

        <div class="note">정답을 맞히면 몬스터에게 피해! 처치 시 무기/방어구와 <strong>포션(10%)</strong> 드랍.</div>
      </section>

      <section class="card rightCol">
        <div>
          <div class="title">전투</div>
          <div class="monster">
            <div class="emoji" id="mobEmoji">👾</div>
            <div style="flex:1">
              <div class="row" style="justify-content:space-between">
                <div class="muted"><span id="bossMark"></span>Lv.<span id="mobLv">1</span> <strong id="mobName">소수 슬라임</strong></div>
                <div class="muted">HP <span id="mobHpText">20</span></div>
              </div>
              <div class="bar hp"><span id="mobHpBar" style="width:100%"></span></div>
            </div>
          </div>
        </div>

        <div>
          <div class="title">문제</div>
          <div class="problem" id="question">문제 준비 중…</div>
          <div class="row" style="margin-top:10px; gap:8px">
            <input type="text" id="answer" placeholder="답 입력 (예: 1.5, 0.75, 2.4 / 또는 10, 0.6)" />
            <button id="btnCheck" class="btn-good">정답!</button>
            <button id="btnHint" class="btn-ghost">힌트</button>
            <button id="btnSkip" class="btn-bad">건너뛰기</button>
            <button id="btnSkill" class="btn-ghost" title="희귀 이상 무기 장착 시 사용 가능 (몬스터당 1회)">스킬</button>
          </div>
          <div class="hint" id="hint"></div>
        </div>

        <div style="min-height:0; display:grid; grid-template-columns:1fr 1fr; gap:8px">
          <div>
            <div class="title">전투 로그</div>
            <div id="log" class="log"></div>
          </div>
          <div>
            <div class="title">설정</div>
            <div class="range">
              <div>난이도: <span class="muted">같은 자리 → 다른 자리 → 자연수÷소수 → 반올림 → 남는 양</span></div>
              <div class="note" style="margin-top:6px">반올림(4단계) 제외하고 <strong>유한소수만 정답</strong>. 제시 수는 가급적 <strong>소수 둘째 자리</strong>까지. <kbd>Enter</kbd>로 채점.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- 📊 랭킹 표 -->
      <section class="card" style="grid-column:1 / -1">
        <div class="title">랭킹</div>
        <div id="ranking" class="log" style="height:auto; max-height:260px"></div>
      </section>
    </div>

    <div class="footer">© 소수의 나눗셈 레벨업 · 6학년 2학기 2단원 • 저장은 브라우저 LocalStorage를 사용합니다.</div>
  </div>

  <!-- 범위/테스트/게임오버 오버레이 -->
  <div class="overlay" id="ovRange">
    <div class="panel">
      <h3>문제 범위 (6학년 2학기 2단원 소수의 나눗셈)</h3>
      <ul>
        <li>① 자릿수가 같은 소수의 나눗셈</li>
        <li>② 자릿수가 다른 소수의 나눗셈</li>
        <li>③ 자연수 나누기 소수</li>
        <li>④ 몫을 반올림하여 나타내기(첫째/둘째/일의자리)</li>
        <li>⑤ 나눠주고 남는 양 구하기</li>
      </ul>
      <div style="text-align:right;margin-top:10px"><button id="closeRange">닫기</button></div>
    </div>
  </div>

  <div class="overlay" id="ovTests">
    <div class="panel">
      <h3>개발자 테스트</h3>
      <pre id="testOut" style="white-space:pre-wrap;background:#101431;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.08)">아직 실행되지 않았습니다.</pre>
      <div style="text-align:right;margin-top:10px"><button id="btnRunTests">테스트 실행</button> <button id="closeTests">닫기</button></div>
    </div>
  </div>

  <div class="overlay" id="gameover">
    <div class="panel">
      <h3>게임 오버</h3>
      <p class="muted">목숨을 모두 소진했습니다. 처음부터 다시 도전!</p>
      <div class="row" style="justify-content:flex-end;gap:8px"><button id="btnRestart">처음부터</button></div>
    </div>
  </div>

  <script>
  'use strict';
  const $ = (s)=>document.querySelector(s);
  const clamp=(x,a,b)=>Math.min(b,Math.max(a,x));
  function setText(sel,t){const el=$(sel); if(el) el.textContent=t;}
  function setWidth(sel,p){const el=$(sel); if(el) el.style.width=p;}
  function openOverlay(id){const el=document.getElementById(id); if(el) el.style.display='flex';}
  function closeOverlay(id){const el=document.getElementById(id); if(el) el.style.display='none';}
  function log(msg){const el=$('#log'); const time=new Date().toLocaleTimeString(); if(el){el.innerHTML='['+time+'] '+msg+'<br>'+el.innerHTML;}}
  function rnd(a,b){return Math.floor(Math.random()*(b-a+1))+a}
  function toFixedTrim(x,k){const s=x.toFixed(k);return s.replace(/\.?0+$/,'');}
  function decToFracParts(str){if(!/^-?\d+(?:\.\d+)?$/.test(str)) return null; if(!str.includes('.')) return [parseInt(str,10),1]; const neg=str.startsWith('-'); const s=neg?str.slice(1):str; const [A,B]=s.split('.'); const d=10**B.length; const n=parseInt(A,10)*d+parseInt(B,10); return [neg?-n:n,d];}
  function randDec(places=2){ if(places===1){return (rnd(1,99)/10).toFixed(1);} return (rnd(1,999)/100).toFixed(2);} 
  function pick(arr){return arr[Math.floor(Math.random()*arr.length)];}
  // 새로 추가: 표시용으로 끝 0을 제거한 문자열과, 제거 후 자리수 계산
  function trimZerosStr(s){
    if(!s.includes('.')) return s;
    // 소수점 뒤 불필요한 0 제거 (ex: 0.40 -> 0.4, 2.50 -> 2.5, 3.00 -> 3)
    return s.replace(/0+$/,'').replace(/\.$/, '');
  }
  function decPlacesTrimmed(s){
    const m = String(s).split('.'); if(m.length<2) return 0; return m[1].replace(/0+$/,'').length;
  }
  // 표시에 쓰는 공통 포맷터: 숫자/문자 모두 끝 0 제거한 문자열로 반환
  function fmt(x){ return trimZerosStr(String(x)); }

  // ✅ 정답 목표 3개로 변경
  const STAGE_GOAL=3;
  
  const state={level:1,xp:0,maxHp:100,hp:100,baseAtk:5,lives:1,stage:{world:1,index:1,correct:0},mob:null,problem:null,freeplay:false};

  function needXpFor(lv){return 50+(lv-1)*25}
  function totalAtk(){return state.baseAtk+(state.level-1)*2}

  function newMonster(){const lv=state.level+(state.stage.world-1); const namePool=['소수 슬라임','반올림 스프라이트','자리올림 고블린','나머지 임프']; const mhp=lv<4?rnd(12,18):(lv<8?rnd(22,34):rnd(40,60)); const atk=lv<4?rnd(2,4):(lv<8?rnd(4,7):rnd(7,11)); state.mob={name:pick(namePool),level:lv,maxHp:mhp,hp:mhp,atk,boss:false,emoji:'👾'}; setText('#mobName',state.mob.name); setText('#mobLv',lv); setText('#mobHpText',state.mob.hp); setWidth('#mobHpBar',(state.mob.hp/state.mob.maxHp*100).toFixed(1)+'%'); $('#mobEmoji').textContent='👾'; setText('#bossMark',''); renderBars();}

  function renderBars(){ 
    let stageTxt = state.stage.world+'-'+state.stage.index+' (정답 '+state.stage.correct+'/'+STAGE_GOAL+')';
    if(state.freeplay) stageTxt = '자유 연습 모드';
    setText('#stage',stageTxt);
    setWidth('#hpbar',(state.hp/state.maxHp*100).toFixed(1)+'%');
    const need=needXpFor(state.level);
    setWidth('#xpbar',Math.min(100,state.xp/need*100).toFixed(1)+'%');
    setText('#level',state.level);
    setText('#atk',totalAtk());
    const lives=$('#lives'); if(lives){lives.innerHTML=''; for(let i=0;i<state.lives;i++){const s=document.createElement('span'); s.textContent='❤'; lives.appendChild(s);}} 
  }

  function gainXp(x){state.xp+=x; log('경험치 +'+x); while(state.xp>=needXpFor(state.level)){state.xp-=needXpFor(state.level); state.level++; state.maxHp+=12; state.hp=Math.min(state.maxHp,state.hp+20); log('<strong>레벨 업!</strong> 현재 레벨 '+state.level);} renderBars();}

  // 유한소수 보장 도우미 (반올림형 제외)
  function ensureTerminating(nStr, dStr){
    for(let t=0;t<200;t++){
      const A=decToFracParts(nStr); const B=decToFracParts(dStr);
      if(!A||!B){ dStr=randDec(1); continue; }
      const an=A[0],ad=A[1], bn=B[0],bd=B[1]; if(bn===0){ dStr=randDec(1); continue; }
      const N=an*bd, D=ad*bn; // an/ad ÷ bn/bd = an*bd / ad*bn
      const g=(a,b)=>b?g(b,a%b):a; const gg=g(Math.abs(N),Math.abs(D));
      let x=Math.abs(D/gg); while(x%2===0) x/=2; while(x%5===0) x/=5;
      if(x===1) return [nStr,dStr];
      // 제수를 2,5 소인수로만 만드는 방향으로 조정 (10 또는 100의 약수)
      const pow10=pick([1,2]); const base=Math.pow(10,pow10); const mul=pick([2,4,5,8,10,20,25,40,50]);
      dStr=(mul/base).toFixed(pow10);
    }
    return [nStr,dStr];
  }

  // 문제 생성기
  function makeProblemByStage(){
    const idx = state.freeplay ? pick([1,2,3,4,5]) : state.stage.index; // 자유 연습: 5유형 랜덤
    let text='', ans=null, hint='', kind='number'; // kind: number | rounding | pair

    if(idx===1){ // 자릿수 같은 소수 (끝 0은 자릿수로 취급하지 않음)
      const places = pick([1,2]);
      let a,b,av,bv; let tries=0;
      while(true){
        a = trimZerosStr(randDec(places)); b = trimZerosStr(randDec(places));
        ;[a,b] = ensureTerminating(a,b);
        a = trimZerosStr(a); b = trimZerosStr(b);
        if(decPlacesTrimmed(a)>0 && decPlacesTrimmed(a)===decPlacesTrimmed(b)) break;
        if(++tries>50){ a='1.2'; b='0.3'; break; }
      }
      av=parseFloat(a); bv=parseFloat(b);
      text = fmt(a)+' ÷ '+fmt(b); ans = av/bv; hint='같은 자리수(끝 0 제외) → 소수점 동시에 오른쪽 이동';
    }
    else if(idx===2){ // 자릿수 다른 소수 (끝 0 제외 기준)
      let a,b,av,bv; let tries=0;
      while(true){
        a = trimZerosStr(randDec(pick([1,2])));
        b = trimZerosStr(randDec(pick([1,2])));
        if(Math.random()<0.5){ const t=a; a=b; b=t; }
        ;[a,b] = ensureTerminating(a,b);
        a = trimZerosStr(a); b = trimZerosStr(b);
        const da=decPlacesTrimmed(a), db=decPlacesTrimmed(b);
        if(da!==db && da>0 && db>0) break;
        if(++tries>60){ a='2.4'; b='0.3'; break; }
      }
      av=parseFloat(a); bv=parseFloat(b);
      text = fmt(a)+' ÷ '+fmt(b); ans = av/bv; hint='제수를 정수로 만들기 위해 둘 다 같은 만큼 곱하기(끝 0 제외 기준)';
    }
    else if(idx===3){ // 자연수 ÷ 소수 (끝 0 제외)
      let A = String(rnd(2,50)); let b = trimZerosStr(randDec(pick([1,2])));
      ;[A,b] = ensureTerminating(String(A), b);
      b = trimZerosStr(b);
      text = fmt(A)+' ÷ '+fmt(b); ans = parseFloat(A)/parseFloat(b); hint='제수를 정수로 바꾸기 (둘 다 ×10 또는 ×100)';
    }
    else if(idx===4){ // 반올림
      const a = trimZerosStr(randDec(pick([1,2]))); const b = trimZerosStr(randDec(pick([1,2])));
      const target = pick(['첫째자리','둘째자리','일의자리']);
      text = fmt(a)+' ÷ '+fmt(b)+' (몫을 '+target+'까지 반올림)';
      const raw = parseFloat(a)/parseFloat(b);
      kind='rounding'; ans={raw, target};
      hint='규칙: 5이상 올림, 미만 버림';
    }
    else { // idx===5 나눠주고 남는 양
      let X = trimZerosStr((rnd(12,200)/10).toFixed(pick([1,2])));
      let Y = trimZerosStr((rnd(5,150)/10).toFixed(pick([1,2])));
      const xv=parseFloat(X), yv=parseFloat(Y);
      const cnt = Math.floor((xv+1e-9)/yv); // 안전한 내림
      const remain = xv - cnt*yv;
      const rFixed = Math.round(remain*100)/100; // 둘째자리까지 반올림 표기
      text = fmt(X)+'를 '+fmt(Y)+'씩 나누어 담습니다. 만들 수 있는 개수와 남는 양은? (형식: 개수, 남는양)';
      ans = {cnt, rem: rFixed};
      hint='개수 = 몫의 정수부분, 남는 양 = 전체 - (개수×한 개 분량)';
      kind='pair';
    }

    return {text, ans, hint, kind};
  }

  // ====== 채점 ======
  function parseNumberInput(s){ s=(s||'').trim().replace(/\s+/g,''); if(!s) return null; if(!/^[-+]?\d*(?:\.\d+)?$/.test(s)) return null; return parseFloat(s); }
  function checkAnswer(){
    const p = state.problem; const inp = $('#answer'); const v = inp? inp.value: '';
    if(!p){ log('문제가 없습니다.'); return; }

    // 표준 비교 도우미: 원하는 자리까지 반올림 후 불필요한 0 제거 문자열로 비교
    const canon = (x,k=2)=> toFixedTrim(parseFloat(x), k);

    // ⑤ 나눠주고 남는 양 (형식: 개수, 남는양)
    if(p.kind==='pair'){
      const m = v.split(','); if(m.length!==2){ log('형식: 개수, 남는양  (예: 10, 0.6)'); return; }
      const a = parseInt(m[0].trim(),10); const b = parseNumberInput(m[1]);
      if(Number.isNaN(a) || b==null){ log('형식: 개수, 남는양  (예: 10, 0.6)'); return; }
      const ok = (a===p.ans.cnt) && (canon(b,2) === canon(p.ans.rem,2));
      finalize(ok, ok? '정답! ('+p.ans.cnt+', '+canon(p.ans.rem,2)+')':'오답! 정답은 '+p.ans.cnt+', '+canon(p.ans.rem,2));
      return;
    }

    // ④ 반올림 채점 (일의자리/첫째/둘째)
    if(p.kind==='rounding'){
      const target=p.ans.target; const want = (target==='첫째자리'?1: (target==='둘째자리'?2:-1));
      const inNum = parseNumberInput(v); if(inNum==null){ log('숫자로 입력해 주세요.'); return; }
      if(want===-1){
        const correct = Math.round(p.ans.raw);
        const ok = Math.abs(inNum - correct) < 1e-9;
        finalize(ok, ok? '정답! '+correct : '오답! 정답은 '+correct);
      } else {
        const factor = Math.pow(10, want);
        const correctVal = Math.round(p.ans.raw * factor)/factor;
        const ok = (canon(inNum, want) === canon(correctVal, want));
        finalize(ok, ok? '정답! '+canon(correctVal, want) : '오답! 정답은 '+canon(correctVal, want));
      }
      return;
    }

    // 일반 숫자 문제 (①②③): 소수 둘째자리까지 표준 문자열 비교
    const num = parseNumberInput(v); if(num==null){ log('숫자로 입력해 주세요.'); return; }
    const ok = (canon(num,2) === canon(p.ans,2));
    finalize(ok, ok? '정답! '+canon(p.ans,2): '오답! 정답은 '+canon(p.ans,2));
  }

  function damageToMonster(ok){
    if(ok){ const base=totalAtk(); const crit=Math.random()<0.1; const dmg=crit?Math.round(base*1.6):base; state.mob.hp=Math.max(0, state.mob.hp-dmg); setText('#mobHpText', state.mob.hp); setWidth('#mobHpBar', (state.mob.hp/state.mob.maxHp*100).toFixed(1)+'%'); log('정답! '+dmg+' 피해'+(crit?' (치명타)':'')+'.'); if(state.mob.hp===0){ gainXp(25+state.mob.level*8); newMonster(); } }
    else { const dmg=Math.max(1, state.mob.atk); state.hp=clamp(state.hp-dmg,0,state.maxHp); renderBars(); log('오답… 반격 '+dmg+' 피해'); if(state.hp===0){ openOverlay('gameover'); }}
  }

  function nextProblem(){ state.problem = makeProblemByStage(); setText('#question', state.problem.text); setText('#hint',''); const a=$('#answer'); if(a) a.value=''; }

  function finalize(correct, msg){
    log(msg);
    if(correct){ state.stage.correct++; damageToMonster(true); if(!state.freeplay && state.stage.correct>=STAGE_GOAL){
        state.stage.correct=0; state.stage.index++;
        if(state.stage.index>5){ state.stage.index=1; state.stage.world++; log('<strong>월드 업!</strong>'); state.freeplay=true; log('<strong>축하합니다! 모든 스테이지를 클리어했습니다.</strong> 이제 자유 연습 모드에서 계속 문제를 풀 수 있습니다.'); }
        else { log('<strong>스테이지 클리어!</strong> 다음 스테이지로 이동'); }
      }
      renderBars();
      nextProblem();
    } else { damageToMonster(false); nextProblem(); }
  }

  function bindUI(){
    const btnCheck=$('#btnCheck'); if(btnCheck) btnCheck.addEventListener('click', checkAnswer);
    const ans=$('#answer'); if(ans) ans.addEventListener('keydown', (e)=>{ if(e.key==='Enter') checkAnswer();});
    const btnSkip=$('#btnSkip'); if(btnSkip) btnSkip.addEventListener('click', ()=>{ log('문제 건너뛰기'); nextProblem();});
    const btnRange=$('#btnRange'); if(btnRange) btnRange.addEventListener('click', ()=>openOverlay('ovRange'));
    const closeRange=$('#closeRange'); if(closeRange) closeRange.addEventListener('click', ()=>closeOverlay('ovRange'));
    const btnReset=$('#btnReset'); if(btnReset) btnReset.addEventListener('click', ()=>{ location.reload(); });
    const btnRestart=$('#btnRestart'); if(btnRestart) btnRestart.addEventListener('click', ()=>{ location.reload(); });
    const btnTests=$('#btnTests'); if(btnTests) btnTests.addEventListener('click', ()=>{ openOverlay('ovTests'); runTests(); });
    const closeTests=$('#closeTests'); if(closeTests) closeTests.addEventListener('click', ()=>closeOverlay('ovTests'));
    const btnRunTests=$('#btnRunTests'); if(btnRunTests) btnRunTests.addEventListener('click', runTests);
    const btnHint=$('#btnHint'); if(btnHint) btnHint.addEventListener('click', ()=>{ if(state.problem) setText('#hint', state.problem.hint);});
  }

  // 간단 테스트 러너 (기존 설명 + 추가 테스트 케이스)
  function runTests(){
    const out=$('#testOut'); if(!out) return;
    const lines=[];
    function assert(name, cond, detail=''){ lines.push((cond?'✅ ':'❌ ')+name+(detail? ' -> '+detail:'')); }

    // 기존: 규칙 설명
    lines.push('스테이지 규칙:');
    lines.push('1 같은 자리 소수 ÷ 소수');
    lines.push('2 다른 자리 소수 ÷ 소수');
    lines.push('3 자연수 ÷ 소수');
    lines.push('4 반올림');
    lines.push('5 나눠주고 남는 양 (정답 형식: 개수, 남는양)');
    lines.push('\n추가 자동 테스트:');

    // 1) 유한소수 보장 테스트 여러 건
    const pairs=[["4.56","1.52"],["2.1","3.12"],["12","1.5"],["7.5","0.25"],["0.4","0.2"]];
    for(const [a,b] of pairs){
      const [na,nb]=ensureTerminating(a,b);
      const A=decToFracParts(na), B=decToFracParts(nb);
      const N=A[0]*B[1], D=A[1]*B[0];
      const g=(x,y)=>y?g(y,x%y):x; let x=Math.abs(D/g(N,D)); while(x%2===0) x/=2; while(x%5===0) x/=5; assert(`유한소수 검사 ${na} ÷ ${nb}`, x===1, `분모 소인수=${x}`);
    }

    // 2) 반올림 규칙 테스트
    const r1=Math.round(1.24*10)/10; assert('반올림 첫째자리(1.24→1.2)', Math.abs(r1-1.2)<1e-9);
    const r2=Math.round(1.25*10)/10; assert('반올림 첫째자리(1.25→1.3)', Math.abs(r2-1.3)<1e-9);
    const r3=Math.round(12.345*100)/100; assert('반올림 둘째자리(12.345→12.35)', Math.abs(r3-12.35)<1e-9);

    // 3) 남는 양 계산 테스트
    const xv=12.6, yv=1.2; const cnt=Math.floor((xv+1e-9)/yv); const rem=Math.round((xv-cnt*yv)*100)/100; assert('남는 양(12.6, 1.2)', cnt===10 && Math.abs(rem-0.6)<1e-9, `cnt=${cnt}, rem=${rem}`);

    out.textContent = lines.join('\n');
  }

  // ====== 공유/랭킹 유틸 (클라이언트 전용) ======
  // 교사용 설정: 여기에 웹앱 URL을 1회만 설정하면 학생들은 URL을 볼 필요/권한이 없습니다.
  const SUBMIT_URL = 'https://script.google.com/macros/s/AKfycbwJp4zbLpCXJXKJ72LkdwD3OsexfGI0b2dqX7UHN-VkmkDdcxfI4kGsSmFT0WjCBp4I/exec';// Google Apps Script Web App URL
  const LIST_URL   = 'https://script.google.com/macros/s/AKfycbwJp4zbLpCXJXKJ72LkdwD3OsexfGI0b2dqX7UHN-VkmkDdcxfI4kGsSmFT0WjCBp4I/exec';// same URL handles GET

  const STORE_KEY = 'rpg_divdec_settings_v1';
  const MOCK_KEY = 'rpg_divdec_mockrank_v1';

  function saveSettings(){
    const o={ name: document.getElementById('nameInput')?.value||'', rankBy: document.getElementById('rankBy')?.value||'correct' };
    localStorage.setItem(STORE_KEY, JSON.stringify(o));
    updateShareNote();
  }
  function loadSettings(){
    try{ const raw=localStorage.getItem(STORE_KEY); if(!raw) return; const o=JSON.parse(raw);
      if(o.name) document.getElementById('nameInput').value=o.name;
      if(o.rankBy) document.getElementById('rankBy').value=o.rankBy;
    }catch(e){}
    updateShareNote();
  }
  function updateShareNote(){
    const hasRemote = !!(SUBMIT_URL && LIST_URL);
    setText('#shareNote', hasRemote? '온라인 모드: 제출/랭킹이 스프레드시트와 동기화됩니다.' : '오프라인(로컬 모의 랭킹) 모드: 코드 상단 URL 설정 필요');
  }

  function currentStageNumeric(){ return state.stage.world*10 + state.stage.index; }

  // 현재 상태 → 4가지 점수를 모두 산출
  function getAllScores(){
    return {
      correct: state.totalCorrect||0,
      level: state.level,
      xp: state.xp,
      stage: currentStageNumeric()
    };
  }

  function fmtStage(n){ const w=Math.floor(n/10), i=n%10; return w+'-'+i; }

  // 표 그리기: 4가지 점수 모두 노출
  function renderRanking(list){
    const box=document.getElementById('ranking'); if(!box) return;
    if(!list || !list.length){ box.innerHTML='<span class="muted">랭킹 데이터가 없습니다.</span>'; return; }
    let html='<table style="width:100%; border-collapse:collapse">'+
      '<thead><tr style="text-align:left">'
      +'<th style="padding:6px 4px">#</th>'
      +'<th style="padding:6px 4px">이름</th>'
      +'<th style="padding:6px 4px">정답수</th>'
      +'<th style="padding:6px 4px">레벨</th>'
      +'<th style="padding:6px 4px">경험치</th>'
      +'<th style="padding:6px 4px">스테이지</th>'
      +'<th style="padding:6px 4px">등록시각</th>'
      +'</tr></thead><tbody>';
    list.forEach((r,idx)=>{
      const when = r.timestamp? new Date(r.timestamp).toLocaleString():'';
      const stageTxt = (typeof r.stage==='number')? fmtStage(r.stage): (r.stageText||'');
      html += `<tr>`
        + `<td style="padding:6px 4px">${idx+1}</td>`
        + `<td style="padding:6px 4px">${r.name||''}</td>`
        + `<td style="padding:6px 4px">${r.correct ?? r.score ?? ''}</td>`
        + `<td style="padding:6px 4px">${r.level ?? ''}</td>`
        + `<td style="padding:6px 4px">${r.xp ?? ''}</td>`
        + `<td style="padding:6px 4px">${stageTxt}</td>`
        + `<td style="padding:6px 4px">${when}</td>`
        + `</tr>`;
    });
    html+='</tbody></table>';
    box.innerHTML=html;
  }

  function addMockRecord(rec){
    const raw=localStorage.getItem(MOCK_KEY);
    const arr = raw? JSON.parse(raw): [];
    arr.push(rec);
    localStorage.setItem(MOCK_KEY, JSON.stringify(arr));
  }
  function getMockRanking(){
    const raw=localStorage.getItem(MOCK_KEY);
    const arr = raw? JSON.parse(raw): [];
    const by = document.getElementById('rankBy')?.value||'correct';
    arr.sort((a,b)=> ( (b[by]??0) - (a[by]??0) ) || (new Date(b.timestamp)-new Date(a.timestamp)) );
    return arr;
  }

  async function sendScore(){
    const name = document.getElementById('nameInput')?.value?.trim();
    if(!name){ log('이름을 입력해 주세요.'); return; }
    const scores = getAllScores();
    const payload = {
      name,
      ...scores, // correct, level, xp, stage
      stageText: state.stage.world+'-'+state.stage.index,
      timestamp: new Date().toISOString()
    };
    if(!(SUBMIT_URL)){
      addMockRecord(payload); log('로컬 모드: 점수가 임시 랭킹에 저장되었습니다.');
      renderRanking(getMockRanking()); return;
    }
    try{
      const res = await fetch(SUBMIT_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
      if(!res.ok){ throw new Error('HTTP '+res.status); }
      const data = await res.json().catch(()=>({ok:true}));
      log('점수 전송 완료'); if(data?.ok===false) log('서버 응답: '+(data?.message||'실패'));
    }catch(e){ log('전송 실패 - '+e.message+' (로컬 모드로 저장)'); addMockRecord(payload); }
    renderRanking(await fetchRanking());
  }

async function fetchRanking(){
  if(!(LIST_URL)) return getMockRanking();
  try{
    const res = await fetch(LIST_URL, {method:'GET'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();

    // 다양한 응답 형태 방어
    let arr = null;
    if (Array.isArray(data)) arr = data;
    else if (data && Array.isArray(data.data)) arr = data.data;
    else if (data && Array.isArray(data.rows)) arr = data.rows;
    else if (data && data.ok === false) throw new Error(data.message || 'ok:false');
    else throw new Error('Unexpected JSON shape');

    const by = document.getElementById('rankBy')?.value || 'correct';
    arr.sort((a,b)=> ((Number(b[by])||0) - (Number(a[by])||0)) || (new Date(b.timestamp) - new Date(a.timestamp)) );
    return arr;
  }catch(e){
    log('랭킹 불러오기 실패 - ' + e.message + ' (로컬 모드 사용)');
    return getMockRanking();
  }
}
  // 누적 정답수 집계 및 훅
  state.totalCorrect = 0;
  const __finalize = finalize; // 기존 참조 보관
  finalize = function(correct, msg){ if(correct){ state.totalCorrect = (state.totalCorrect||0) + 1; } __finalize(correct, msg); }

  // UI 바인딩 확장
  const __bindUI = bindUI;
  bindUI = function(){
    __bindUI();
    ['nameInput','rankBy'].forEach(id=>{
      const el=document.getElementById(id); if(el){ el.addEventListener('change', saveSettings); el.addEventListener('blur', saveSettings); }
    });
    // 기준 변경 시 즉시 랭킹 재조회
    const rankSel=document.getElementById('rankBy');
    if(rankSel){ rankSel.addEventListener('change', async ()=>{ renderRanking(await fetchRanking()); }); }

    const btnSend=document.getElementById('btnSendScore'); if(btnSend) btnSend.addEventListener('click', sendScore);
    const btnRank=document.getElementById('btnFetchRank'); if(btnRank) btnRank.addEventListener('click', async ()=>{ renderRanking(await fetchRanking()); });
  };

window.addEventListener('DOMContentLoaded', async ()=>{
    renderBars(); newMonster(); nextProblem(); bindUI();
    loadSettings();
    renderRanking(await fetchRanking());
  });
  </script>
</body>
</html>

